(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{433:function(s,a,t){"use strict";t.r(a);var n=t(7),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("hr"),s._v(" "),a("h1",{attrs:{id:"mongodb-restore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-restore"}},[s._v("#")]),s._v(" MongoDB Restore")]),s._v(" "),a("p",[s._v("当自建数据库时，需要备份和恢复数据库，这里将对 MongoDB 的备份和恢复进行介绍。对于备份和回复可借助gpt快速完成。")]),s._v(" "),a("h2",{attrs:{id:"备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份"}},[s._v("#")]),s._v(" 备份")]),s._v(" "),a("p",[s._v("使用mongodump命令备份数据库，可参照"),a("a",{attrs:{href:"https://www.mongodb.com/zh-cn/docs/database-tools/mongodump/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 MongoDB 相关变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DB_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DB_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"27017"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DB_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"school"')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换为你的数据库名称")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BACKUP_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/backups/mongo_school"')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换为你的备份目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DATE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y%m%d_%H%M%S"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"world"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建备份文件夹")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行 mongodump 命令，生成备份")]),s._v("\nmongodump "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--username")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$USERNAME")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--password")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PASSWORD")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--authenticationDatabase")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DB_HOST")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DB_PORT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--db")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DB_NAME")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--out")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DB_NAME_")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打包备份文件为 tar.gz 压缩包")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zcvf")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v("/mongodb_backup_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v(".tar.gz "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DB_NAME_")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除未压缩的备份文件夹")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DB_NAME_")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上传备份文件到华为云 OBS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OBS_BUCKET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ziga"')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换为你的OBS桶名称")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OBS_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backup/mongo_school"')]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换为你希望存储的 OBS 路径")]),s._v("\n/root/download/obsutil_linux_amd64_5.5.12/obsutil "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v("/mongodb_backup_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v(".tar.gz obs://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OBS_BUCKET")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OBS_DIR")]),s._v("/\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除旧备份文件，只保留最近 10 个文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BACKUP_DIR")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" mongodb_backup_*.tar.gz "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1,10d'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出备份完成信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"MongoDB 数据备份已完成并上传至华为云 OBS: '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OBS_BUCKET")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OBS_DIR")]),s._v("/mongodb_backup_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v('.tar.gz"')]),s._v("\n\n\n "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://oapi.dingtalk.com/robot/send?access_token=ca462bb7sdfasd767asdxchj789'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"msgtype": "text","text": {"content":"【通知】mongodb 数据库备份完成"}}\'')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("h2",{attrs:{id:"恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复"}},[s._v("#")]),s._v(" 恢复")]),s._v(" "),a("p",[s._v("在没有密码的情况下，可以直接恢复数据库。可参照"),a("a",{attrs:{href:"https://www.mongodb.com/zh-cn/docs/database-tools/mongorestore/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mongore dump_folder\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"无密码启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#无密码启动"}},[s._v("#")]),s._v(" 无密码启动")]),s._v(" "),a("p",[s._v("避免记忆密码，可以配置不开启授权，从而无密码启动；启动完成后即可无密码恢复，恢复完成后再开启授权。")]),s._v(" "),a("p",[s._v("通常，mongo使用systemctl启动，可查看对应的service文件，找到配置文件。")]),s._v(" "),a("p",[s._v("例如我安装的mongo配置文件路径为："),a("code",[s._v("/etc/mongod.conf")])]),s._v(" "),a("p",[s._v("对应的service文件为："),a("code",[s._v("/usr/lib/systemd/system/mongod.service")])]),s._v(" "),a("h2",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[s._v("#")]),s._v(" 注意事项")]),s._v(" "),a("p",[s._v("当mongo使用命令行启动，而不是systemctl启动时，可能使用root用户启动，从而导致生成了root权限的mongo相关文件，继而再使用systemctl启动时，mongo无法启动")])])}),[],!1,null,null,null);a.default=e.exports}}]);